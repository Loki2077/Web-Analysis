# **网站流量分析系统技术文档**  

## **1. 项目概述**  
本项目是一个基于 **Next.js** 开发的 **开源网站流量分析系统**，旨在帮助用户监测网站访问情况。用户只需在其网站中引入一个 **JS 脚本**，系统即可自动采集访问数据，并在 **可视化仪表盘** 中展示分析结果。  

本系统 **无需后端服务器**，所有数据存储在 **Vercel Blob Storage**，适用于个人网站、博客或小型项目。  

---

## **2. 技术栈**  
| 组件 | 技术选型 | 说明 |
|------|------|------|
| **前端埋点 SDK** | JavaScript / TypeScript | 采集网站访问数据，发送至后端 |
| **后端 API** | Next.js API Routes | 处理数据存储与查询 |
| **数据存储** | Vercel Blob Storage | 存储访问日志 |
| **数据可视化** | Next.js + Chart.js / Recharts | 提供管理面板展示流量数据 |
| **部署** | Vercel | 便捷的云部署方案 |

---

## **3. 功能模块**  

### **3.1. 数据采集（前端埋点 SDK）**  
埋点 SDK 负责监听用户访问网站时的行为数据，并将其发送到后端 API 进行存储。  

#### **📌 采集的数据类型**
| 数据项 | 说明 |
|--------|------|
| **访问 URL** | 记录用户访问的具体页面地址 |
| **访问来源（Referrer）** | 记录用户从哪个网站跳转过来 |
| **设备信息（User-Agent）** | 记录访问者的浏览器、操作系统等信息 |
| **停留时长（Duration）** | 计算用户在页面上的停留时间 |
| **IP 地址** | 由后端获取，用于分析访问地域 |

#### **📌 数据采集方式**
- **监听页面加载事件**，记录 `window.location.href` 和 `document.referrer`。  
- **监听页面关闭事件**（`beforeunload`），计算停留时间。  
- **定期上报数据**（如每 10 秒上报一次），防止数据丢失。  
- **使用 Fetch API 发送数据** 到后端 API。  

#### **📌 SDK 运行方式**
- 通过 `<script>` 标签引入 SDK，无需额外配置。  
- SDK 体积小（< 5KB），不影响页面性能。  
- **异步加载**，不会阻塞页面渲染。  

---

### **3.2. 数据存储（Vercel Blob Storage）**  
Vercel Blob Storage 用于存储访问数据，主要特点：  
- **自动扩展**，适合存储大量小型 JSON 日志文件。  
- **无需额外数据库**，节省成本和维护工作。  
- **支持文件访问权限管理**，保证数据安全性。  

#### **📌 存储方式**
- 每次访问记录 **单独存储为 JSON 文件**（按网站，日期，时间戳等命名）。
- 文件结构示例：
  ```
  /analytics/
    ├── 2025-04-01/
    │   ├── 08:00.json
    │   ├── 08:05.json
  ```
- **数据格式**
  ```json
  {
    "url": "https://example.com",
    "referrer": "https://google.com",
    "userAgent": "Mozilla/5.0",
    "duration": 12000,
    "ip": "192.168.1.1",
    "timestamp": "2025-04-01T08:00:00Z"
  }
  ```
- **数据归档策略**
  - **短期存储**：最近 7 天的数据可供查询。  
  - **长期存储**：数据定期打包归档（例如每月生成一个 CSV/JSON 归档文件）。  

---

### **3.3. 后端 API（数据处理与查询）**  
后端 API 负责接收前端 SDK 发送的访问数据，并存储至 Vercel Blob Storage。同时，提供查询接口，支持仪表盘获取数据。  

#### **📌 API 设计**
| API 路径 | 方法 | 说明 |
|----------|------|------|
| `/api/track` | `POST` | 接收前端发送的访问数据并存储 |
| `/api/get-analytics` | `GET` | 查询存储的数据，用于前端可视化 |

#### **📌 业务逻辑**
- **数据去重**：避免重复存储相同的访问记录。  
- **IP 处理**：后端解析 IP，但只存储哈希值或大致地理位置，保护用户隐私。  
- **异步存储**：提高 API 处理效率。  

---

### **3.4. 数据可视化仪表盘**  
Next.js 提供管理面板，展示收集到的数据，支持图表分析和数据筛选。  

#### **📌 仪表盘功能**
- **访问趋势**（折线图）：统计每日访问量变化。  
- **来源分析**（饼图）：统计用户从哪些网站跳转而来。  
- **设备占比**（柱状图）：展示不同设备类型（手机、PC、平板）访问占比。  
- **访问详情**（表格）：列出每个访问记录，支持导出 CSV。  

#### **📌 数据查询方式**
- **最近 7 天访问数据**：默认查询最近 7 天的访问记录，支持时间范围筛选。  
- **按来源统计**：统计不同来源的网站流量。  
- **按设备类型统计**：分析 PC、移动端、平板的访问比例。  

---

## **4. 部署与使用指南**  

### **4.1. 开发环境配置**
1. **安装 Node.js & Next.js**
   ```sh
   npm install
   ```

2. **运行开发服务器**
   ```sh
   npm run dev
   ```

### **4.2. 部署到 Vercel**
1. **安装 Vercel CLI**
   ```sh
   npm install -g vercel
   ```

2. **部署项目**
   ```sh
   vercel
   ```

3. **获取部署地址**
   - 访问 `https://your-vercel-app.vercel.app`  
   - 仪表盘访问 `https://your-vercel-app.vercel.app/dashboard`  

### **4.3. 用户接入方式**
1. **在用户网站中引入 JS SDK**
   ```html
   <script src="https://your-vercel-app.vercel.app/analytics.js"></script>
   ```
2. **访问仪表盘查看数据**  

---

## **5. 后续优化方向**
| 优化点 | 说明 |
|--------|------|
| **数据查询优化** | 使用 Redis 缓存加速数据查询 |
| **IP 地理位置分析** | 使用 IP 数据库提供大致访客地区信息 |
| **邮件通知** | 统计报告每日/每周发送至用户邮箱 |
| **数据清理策略** | 自动删除 90 天前的日志，减少存储成本 |

---

## **6. 总结**
本系统采用 **Next.js + Vercel Blob Storage**，实现轻量级网站访问数据分析，**无需数据库**，**无服务器维护成本**，适用于个人网站或小型应用。  

未来可扩展 **高级分析功能**，如用户行为路径分析、事件跟踪等，增强数据洞察能力。 🚀