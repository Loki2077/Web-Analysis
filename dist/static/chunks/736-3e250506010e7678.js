"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[736],{8974:(e,o,t)=>{t.d(o,{DataProvider:()=>v,E:()=>u});var a=t(5155),r=t(2115);let n=t(7622),s=null;var i=t(9509);t(7622);let c=i.env.NEXT_PUBLIC_PROJECT_MODE,l=(0,r.createContext)(void 0),d=i.env.MONGODB_DATABASENAME||"web-analysis",v=e=>{let{children:o}=e,[t,i]=(0,r.useState)([]),[v,u]=(0,r.useState)([]),[g,h]=(0,r.useState)([]),[f,m]=(0,r.useState)([]),D="web-analysis-data";return(0,r.useEffect)(()=>{let e;fetch("/api/mongodb?action=fetchData&dbName=".concat(d,"&collectionName=domain")).then(e=>e.json()).then(e=>{e.success&&Array.isArray(e.data)?(i(e.data.map(e=>({...e,onlineUsers:0,eventCount:0}))),"dev"===c&&console.log("[DataProvider] 域名数据加载成功:",e.data.length,"条记录")):(console.error("[DataProvider] 加载域名数据失败或数据格式错误:",e),i([]))}).catch(e=>{console.error("[DataProvider] 获取域名数据时出错:",e),i([])}),fetch("/api/mongodb?action=fetchData&dbName=".concat(d,"&collectionName=user")).then(e=>e.json()).then(e=>{e.success&&Array.isArray(e.data)?(u(e.data),"dev"===c&&console.log("[DataProvider] 用户数据加载成功:",e.data.length,"条记录")):(console.error("[DataProvider] 加载用户数据失败或数据格式错误:",e),u([]))}).catch(e=>{console.error("[DataProvider] 获取用户数据时出错:",e),u([])}),fetch("/api/mongodb?action=fetchData&dbName=".concat(d,"&collectionName=event")).then(e=>e.json()).then(e=>{e.success&&Array.isArray(e.data)?(h(e.data),"dev"===c&&console.log("[DataProvider] 事件数据加载成功:",e.data.length,"条记录")):("dev"===c&&console.error("[DataProvider] 加载事件数据失败或数据格式错误:",e),h([]))}).catch(e=>{console.error("[DataProvider] 获取事件数据时出错:",e),h([])}),fetch("/api/mongodb?action=fetchData&dbName=".concat(d,"&collectionName=details")).then(e=>e.json()).then(e=>{e.success&&Array.isArray(e.data)?(m(e.data),"dev"===c&&console.log("[DataProvider] 详情数据加载成功:",e.data.length,"条记录")):("dev"===c&&console.error("[DataProvider] 加载详情数据失败或数据格式错误:",e),m([]))}).catch(e=>{console.error("[DataProvider] 获取详情数据时出错:",e),m([])});try{e=function(){if(!s){let e="BC-e6e7af2deb5542c38e54635d83c7e038",o="hangzhou.goeasy.io";if(!e||!o)throw Error("GoEasy environment variables (NEXT_PUBLIC_GOEASY_APPKEY, NEXT_PUBLIC_GOEASY_HOST) are not set.");(s=n.getInstance({host:o,appkey:e,modules:["pubsub"]})).connect({onSuccess:function(){console.log("GoEasy connect successfully.")},onFailed:function(e){console.error("Failed to connect GoEasy, code:"+e.code+",error:"+e.content)}})}return s}(),"dev"===c&&console.log("[DataProvider] GoEasy 客户端实例获取成功"),e.pubsub.subscribe({channel:D,onMessage:function(e){"dev"===c&&console.log("[DataProvider] 接收到 GoEasy 消息 - Channel:",e.channel,"内容:",e.content);try{let o=JSON.parse(e.content);if(o&&(h(e=>[...e,o]),"dev"===c&&console.log("[DataProvider] 事件数据更新：插入新事件")),o&&"view"===o.type){let{domain:e,fingerprint:t,ip:a,...r}=o;e&&i(o=>{if(!o.some(o=>o.domain===e)){"dev"===c&&console.log("[DataProvider] 域名数据更新：插入新域名",e);let t={_id:Math.random().toString(36).substring(7),domain:e,onlineUsers:0,eventCount:0,...r};return[...o,t]}return"dev"===c&&console.log("[DataProvider] 域名数据更新：域名已存在，不插入"),o}),t&&a&&e&&u(n=>{let s=n.findIndex(o=>o.fingerprint===t&&o.ip===a&&o.domain===e);if(s>-1){"dev"===c&&console.log("[DataProvider] 用户数据更新：更新 existing user lastSeen",t);let e=[...n];return e[s]={...e[s],lastSeen:o.timestamp,status:"online"},e}{"dev"===c&&console.log("[DataProvider] 用户数据更新：插入新用户",t);let s={_id:Math.random().toString(36).substring(7),fingerprint:t,ip:a,domain:e,createdAt:o.timestamp,lastSeen:o.timestamp,status:"online",...r};return[...n,s]}}),t&&m(e=>{let a=e.findIndex(e=>e.fingerprint===t);if(a>-1){"dev"===c&&console.log("[DataProvider] 详情数据更新：更新 existing detail",t);let r=[...e];return r[a]={...r[a],ip:void 0!==o.ip?o.ip:r[a].ip,os:void 0!==o.os?o.os:r[a].os,browser:void 0!==o.browser?o.browser:r[a].browser,timezone:void 0!==o.timezone?o.timezone:r[a].timezone,language:void 0!==o.language?o.language:r[a].language,referrer:void 0!==o.referrer?o.referrer:r[a].referrer,lastSeen:void 0!==o.timestamp?o.timestamp:r[a].lastSeen},r}{"dev"===c&&console.log("[DataProvider] 详情数据更新：插入新详情",t);let a={_id:Math.random().toString(36).substring(7),...o};return[...e,a]}})}if(o&&"heartbeat"===o.type){let{fingerprint:e}=o;e&&u(t=>{let a=t.findIndex(o=>o.fingerprint===e);if(a>-1){"dev"===c&&console.log("[DataProvider] 用户心跳更新：更新用户状态和 lastSeen",e);let r=[...t];return r[a]={...r[a],lastSeen:o.timestamp,status:"online"},r}return console.log("[DataProvider] 收到心跳，但用户不存在于列表中",e),t})}}catch(e){console.error("[DataProvider] 解析 GoEasy 消息错误:",e)}},onSuccess:function(){"dev"===c&&console.log("[DataProvider] GoEasy 频道订阅成功:",D)},onFailed:function(e){"dev"===c&&console.error("[DataProvider] GoEasy 频道订阅失败:",e)}})}catch(e){"dev"===c&&console.error("[DataProvider] 初始化 GoEasy 或订阅频道失败:",e)}return()=>{e&&e.pubsub&&(e.pubsub.unsubscribe({channel:D,onSuccess:function(){"dev"===c&&console.log("[DataProvider] GoEasy 频道取消订阅成功:",D)},onFailed:function(e){"dev"===c&&console.error("[DataProvider] GoEasy 频道取消订阅失败:",e)}}),console.log("[DataProvider] GoEasy 连接清理完成"))}},[D]),(0,a.jsx)(l.Provider,{value:{domainList:t,userList:v,eventList:g,detailList:f},children:o})},u=()=>{let e=(0,r.useContext)(l);if(void 0===e)throw Error("useData 必须在 DataProvider 内部使用");return e}}}]);