(()=>{var e={};e.id=176,e.ids=[176],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2750:(e,t,n)=>{"use strict";n.r(t),n.d(t,{patchFetch:()=>y,routeModule:()=>p,serverHooks:()=>v,workAsyncStorage:()=>$,workUnitAsyncStorage:()=>g});var r={};n.r(r),n.d(r,{POST:()=>m});var s=n(6559),i=n(8088),o=n(7719),a=n(2190),c=n(9406),u=n.n(c),l=n(5075),f=n.n(l),d=n(5230),h=n.n(d);async function m(e){try{var t;let n=await e.json(),{type:r,timestamp:s,url:i,domain:o,referrer:c,ip:l,fingerprint:f,browser:d,os:h,timezone:m,language:p,location:$,typeData:g}=n,v=(t="Asia/Shanghai",u()(s).tz(t).format("YYYY-MM-DD HH:mm:ss"));n.timestamp=v,console.log("收集API打印数据:",n);let y=e.headers.get("host"),S=e.headers.get("x-forwarded-proto")||"https",O=`${S}://${y}/api/websocket`,D=`${S}://${y}/api/mongodb`,w=process.env.MONGODB_DATABASENAME;return fetch(O,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:JSON.stringify(n)})}).then(e=>e.ok?e.json():(console.error(`[Collect API] WebSocket API responded with status: ${e.status}`),e.json().then(e=>{console.error("[Collect API] WebSocket API error details:",e)}))).then(e=>{e&&e.success?console.log("[Collect API] Data sent to WebSocket API successfully."):e&&e.error&&console.error("[Collect API] Error sending data to WebSocket API:",e.error)}).catch(e=>console.error("[Collect API] Error fetching WebSocket API:",e)),Promise.allSettled([(async()=>{if(!(o&&"string"==typeof o&&o.length>0))return Promise.resolve({status:"fulfilled",value:{success:!1,message:"Invalid domain data, skipped processing."}});let e=`${D}?action=fetchData&dbName=${w}&collectionName=domain&query=${encodeURIComponent(JSON.stringify({domain:o}))}`,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}}),n=await t.json();if(n.success)if(n.data&&n.data.length>0)console.log(`[Collect API] 域名 '${o}' 已存在，跳过插入。`);else{let e=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"insertOne",dbName:w,collectionName:"domain",document:{domain:o,createdAt:new Date}})}),t=await e.json();t.success?console.log(`[Collect API] 域名 '${o}' 插入成功。`):console.error("[Collect API] 插入域名时出错:",t.message)}else console.error("[Collect API] 查找域名时出错:",n.message);return{success:!0,message:"Domain processing completed."}})(),(async()=>{if(!(f&&"string"==typeof f&&f.length>0))return Promise.resolve({status:"fulfilled",value:{success:!1,message:"Invalid fingerprint data, skipped processing user."}});let e=`${D}?action=fetchData&dbName=${w}&collectionName=user&query=${encodeURIComponent(JSON.stringify({fingerprint:f}))}`,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}}),n=await t.json();if(n.success)if(n.data&&n.data.length>0){let e=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"updateOne",dbName:w,collectionName:"user",filter:{fingerprint:f},update:{$set:{domain:o,ip:l,lastSeen:v}}})}),t=await e.json();t.success?console.log(`[Collect API] 用户 '${f}' 数据更新成功。`):console.error(`[Collect API] 更新用户 '${f}' 数据时出错:`,t.message)}else{let e=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"insertOne",dbName:w,collectionName:"user",document:{fingerprint:f,domain:o,ip:l,createdAt:v,lastSeen:v}})}),t=await e.json();t.success?console.log(`[Collect API] 用户 '${f}' 数据插入成功。`):console.error(`[Collect API] 插入用户 '${f}' 数据时出错:`,t.message)}else console.error("[Collect API] 查找用户时出错:",n.message);return{success:!0,message:"User processing completed."}})(),(async()=>{if(!(f&&"string"==typeof f&&f.length>0&&l&&"string"==typeof l&&l.length>0))return Promise.resolve({status:"fulfilled",value:{success:!1,message:"Invalid fingerprint or IP data, skipped processing details."}});let e=`${D}?action=fetchData&dbName=${w}&collectionName=details&query=${encodeURIComponent(JSON.stringify({fingerprint:f,ip:l}))}`,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}}),n=await t.json();if(n.success)if(n.data&&n.data.length>0){let e={lastSeen:v};$&&("string"!=typeof $||"string"==typeof $&&"获取失败"!==$)&&(e.location=$),d&&"object"==typeof d&&d.name&&d.version&&(e.browser=d),h&&"Unknown"!==h&&(e.os=h),m&&"Unknown"!==m&&(e.timezone=m);let t=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"updateOne",dbName:w,collectionName:"details",filter:{fingerprint:f,ip:l},update:{$set:e}})}),n=await t.json();n.success?console.log(`[Collect API] 详细数据 for '${f}' with IP '${l}' 更新成功。`):console.error(`[Collect API] 更新详细数据 for '${f}' with IP '${l}' 时出错:`,n.message)}else{let e=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"insertOne",dbName:w,collectionName:"details",document:{fingerprint:f,ip:l,os:h,browser:d,timezone:m,language:p,referrer:c,location:$,createdAt:v,lastSeen:v,notes:""}})}),t=await e.json();t.success?console.log(`[Collect API] 详细数据 for '${f}' with IP '${l}' 插入成功。`):console.error(`[Collect API] 插入详细数据 for '${f}' with IP '${l}' 时出错:`,t.message)}else console.error("[Collect API] 查找详细数据时出错:",n.message);return{success:!0,message:"Details processing completed."}})(),(async()=>{if(!(r&&"string"==typeof r&&r.length>0&&f&&"string"==typeof f&&f.length>0))return console.warn("[Collect API] Invalid event type or fingerprint data, skipped processing event."),Promise.resolve({success:!1,message:"Invalid event data, skipped processing event."});if("heartbeat"===r)return console.log(`[Collect API] Heartbeat event received for '${f}', skipping database insertion.`),Promise.resolve({success:!0,message:"Heartbeat event processed (no database insertion)."});let e=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"insertOne",dbName:w,collectionName:"event",document:{domain:o,fingerprint:f,type:r,typeData:g,timestamp:v}})}),t=await e.json();return t.success?console.log(`[Collect API] 事件 '${r}' for '${f}' 插入成功。`):console.error("[Collect API] 插入事件时出错:",t.message),{success:!0,message:"Event processing completed."}})()]).then(e=>{console.log("[Collect API] All database operations settled.")}),a.NextResponse.json({message:"Data received successfully."},{status:200})}catch(e){return console.error("Error receiving data:",e),a.NextResponse.json({error:"Failed to receive data.",details:e.message},{status:500})}}u().extend(f()),u().extend(h());let p=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/collect/route",pathname:"/api/collect",filename:"route",bundlePath:"app/api/collect/route"},resolvedPagePath:"E:\\WorkSpace\\Trea_ai\\web-analysis-v2.0.0\\src\\app\\api\\collect\\route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:$,workUnitAsyncStorage:g,serverHooks:v}=p;function y(){return(0,o.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:g})}},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5075:function(e){e.exports=function(){"use strict";var e="minute",t=/[+-]\d\d(?::?\d\d)?/g,n=/([+-]|\d\d)/g;return function(r,s,i){var o=s.prototype;i.utc=function(e){var t={date:e,utc:!0,args:arguments};return new s(t)},o.utc=function(t){var n=i(this.toDate(),{locale:this.$L,utc:!0});return t?n.add(this.utcOffset(),e):n},o.local=function(){return i(this.toDate(),{locale:this.$L,utc:!1})};var a=o.parse;o.parse=function(e){e.utc&&(this.$u=!0),this.$utils().u(e.$offset)||(this.$offset=e.$offset),a.call(this,e)};var c=o.init;o.init=function(){if(this.$u){var e=this.$d;this.$y=e.getUTCFullYear(),this.$M=e.getUTCMonth(),this.$D=e.getUTCDate(),this.$W=e.getUTCDay(),this.$H=e.getUTCHours(),this.$m=e.getUTCMinutes(),this.$s=e.getUTCSeconds(),this.$ms=e.getUTCMilliseconds()}else c.call(this)};var u=o.utcOffset;o.utcOffset=function(r,s){var i=this.$utils().u;if(i(r))return this.$u?0:i(this.$offset)?u.call(this):this.$offset;if("string"==typeof r&&null===(r=function(e){void 0===e&&(e="");var r=e.match(t);if(!r)return null;var s=(""+r[0]).match(n)||["-",0,0],i=s[0],o=60*s[1]+ +s[2];return 0===o?0:"+"===i?o:-o}(r)))return this;var o=16>=Math.abs(r)?60*r:r,a=this;if(s)return a.$offset=o,a.$u=0===r,a;if(0!==r){var c=this.$u?this.toDate().getTimezoneOffset():-1*this.utcOffset();(a=this.local().add(o+c,e)).$offset=o,a.$x.$localOffset=c}else a=this.utc();return a};var l=o.format;o.format=function(e){var t=e||(this.$u?"YYYY-MM-DDTHH:mm:ss[Z]":"");return l.call(this,t)},o.valueOf=function(){var e=this.$utils().u(this.$offset)?0:this.$offset+(this.$x.$localOffset||this.$d.getTimezoneOffset());return this.$d.valueOf()-6e4*e},o.isUTC=function(){return!!this.$u},o.toISOString=function(){return this.toDate().toISOString()},o.toString=function(){return this.toDate().toUTCString()};var f=o.toDate;o.toDate=function(e){return"s"===e&&this.$offset?i(this.format("YYYY-MM-DD HH:mm:ss:SSS")).toDate():f.call(this)};var d=o.diff;o.diff=function(e,t,n){if(e&&this.$u===e.$u)return d.call(this,e,t,n);var r=this.local(),s=i(e).local();return d.call(r,s,t,n)}}}()},5230:function(e){e.exports=function(){"use strict";var e={year:0,month:1,day:2,hour:3,minute:4,second:5},t={};return function(n,r,s){var i,o=function(e,n,r){void 0===r&&(r={});var s,i,o,a,c=new Date(e);return(void 0===(s=r)&&(s={}),(a=t[o=n+"|"+(i=s.timeZoneName||"short")])||(a=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:n,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:i}),t[o]=a),a).formatToParts(c)},a=function(t,n){for(var r=o(t,n),i=[],a=0;a<r.length;a+=1){var c=r[a],u=c.type,l=c.value,f=e[u];f>=0&&(i[f]=parseInt(l,10))}var d=i[3],h=i[0]+"-"+i[1]+"-"+i[2]+" "+(24===d?0:d)+":"+i[4]+":"+i[5]+":000",m=+t;return(s.utc(h).valueOf()-(m-=m%1e3))/6e4},c=r.prototype;c.tz=function(e,t){void 0===e&&(e=i);var n,r=this.utcOffset(),o=this.toDate(),a=o.toLocaleString("en-US",{timeZone:e}),c=Math.round((o-new Date(a))/1e3/60),u=-(15*Math.round(o.getTimezoneOffset()/15))-c;if(Number(u)){if(n=s(a,{locale:this.$L}).$set("millisecond",this.$ms).utcOffset(u,!0),t){var l=n.utcOffset();n=n.add(r-l,"minute")}}else n=this.utcOffset(0,t);return n.$x.$timezone=e,n},c.offsetName=function(e){var t=this.$x.$timezone||s.tz.guess(),n=o(this.valueOf(),t,{timeZoneName:e}).find(function(e){return"timezonename"===e.type.toLowerCase()});return n&&n.value};var u=c.startOf;c.startOf=function(e,t){if(!this.$x||!this.$x.$timezone)return u.call(this,e,t);var n=s(this.format("YYYY-MM-DD HH:mm:ss:SSS"),{locale:this.$L});return u.call(n,e,t).tz(this.$x.$timezone,!0)},s.tz=function(e,t,n){var r=n&&t,o=n||t||i,c=a(+s(),o);if("string"!=typeof e)return s(e).tz(o);var u=function(e,t,n){var r=e-60*t*1e3,s=a(r,n);if(t===s)return[r,t];var i=a(r-=60*(s-t)*1e3,n);return s===i?[r,s]:[e-60*Math.min(s,i)*1e3,Math.max(s,i)]}(s.utc(e,r).valueOf(),c,o),l=u[0],f=u[1],d=s(l).utcOffset(f);return d.$x.$timezone=o,d},s.tz.guess=function(){return Intl.DateTimeFormat().resolvedOptions().timeZone},s.tz.setDefault=function(e){i=e}}}()},6487:()=>{},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9406:function(e){e.exports=function(){"use strict";var e="millisecond",t="second",n="minute",r="hour",s="week",i="month",o="quarter",a="year",c="date",u="Invalid Date",l=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,f=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,d=function(e,t,n){var r=String(e);return!r||r.length>=t?e:""+Array(t+1-r.length).join(n)+e},h="en",m={};m[h]={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(e){var t=["th","st","nd","rd"],n=e%100;return"["+e+(t[(n-20)%10]||t[n]||t[0])+"]"}};var p="$isDayjsObject",$=function(e){return e instanceof S||!(!e||!e[p])},g=function e(t,n,r){var s;if(!t)return h;if("string"==typeof t){var i=t.toLowerCase();m[i]&&(s=i),n&&(m[i]=n,s=i);var o=t.split("-");if(!s&&o.length>1)return e(o[0])}else{var a=t.name;m[a]=t,s=a}return!r&&s&&(h=s),s||!r&&h},v=function(e,t){if($(e))return e.clone();var n="object"==typeof t?t:{};return n.date=e,n.args=arguments,new S(n)},y={s:d,z:function(e){var t=-e.utcOffset(),n=Math.abs(t);return(t<=0?"+":"-")+d(Math.floor(n/60),2,"0")+":"+d(n%60,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var r=12*(n.year()-t.year())+(n.month()-t.month()),s=t.clone().add(r,i),o=n-s<0,a=t.clone().add(r+(o?-1:1),i);return+(-(r+(n-s)/(o?s-a:a-s))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(u){return({M:i,y:a,w:s,d:"day",D:c,h:r,m:n,s:t,ms:e,Q:o})[u]||String(u||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}};y.l=g,y.i=$,y.w=function(e,t){return v(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var S=function(){function d(e){this.$L=g(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[p]=!0}var h=d.prototype;return h.parse=function(e){this.$d=function(e){var t=e.date,n=e.utc;if(null===t)return new Date(NaN);if(y.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var r=t.match(l);if(r){var s=r[2]-1||0,i=(r[7]||"0").substring(0,3);return n?new Date(Date.UTC(r[1],s,r[3]||1,r[4]||0,r[5]||0,r[6]||0,i)):new Date(r[1],s,r[3]||1,r[4]||0,r[5]||0,r[6]||0,i)}}return new Date(t)}(e),this.init()},h.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},h.$utils=function(){return y},h.isValid=function(){return this.$d.toString()!==u},h.isSame=function(e,t){var n=v(e);return this.startOf(t)<=n&&n<=this.endOf(t)},h.isAfter=function(e,t){return v(e)<this.startOf(t)},h.isBefore=function(e,t){return this.endOf(t)<v(e)},h.$g=function(e,t,n){return y.u(e)?this[t]:this.set(n,e)},h.unix=function(){return Math.floor(this.valueOf()/1e3)},h.valueOf=function(){return this.$d.getTime()},h.startOf=function(e,o){var u=this,l=!!y.u(o)||o,f=y.p(e),d=function(e,t){var n=y.w(u.$u?Date.UTC(u.$y,t,e):new Date(u.$y,t,e),u);return l?n:n.endOf("day")},h=function(e,t){return y.w(u.toDate()[e].apply(u.toDate("s"),(l?[0,0,0,0]:[23,59,59,999]).slice(t)),u)},m=this.$W,p=this.$M,$=this.$D,g="set"+(this.$u?"UTC":"");switch(f){case a:return l?d(1,0):d(31,11);case i:return l?d(1,p):d(0,p+1);case s:var v=this.$locale().weekStart||0,S=(m<v?m+7:m)-v;return d(l?$-S:$+(6-S),p);case"day":case c:return h(g+"Hours",0);case r:return h(g+"Minutes",1);case n:return h(g+"Seconds",2);case t:return h(g+"Milliseconds",3);default:return this.clone()}},h.endOf=function(e){return this.startOf(e,!1)},h.$set=function(s,o){var u,l=y.p(s),f="set"+(this.$u?"UTC":""),d=((u={}).day=f+"Date",u[c]=f+"Date",u[i]=f+"Month",u[a]=f+"FullYear",u[r]=f+"Hours",u[n]=f+"Minutes",u[t]=f+"Seconds",u[e]=f+"Milliseconds",u)[l],h="day"===l?this.$D+(o-this.$W):o;if(l===i||l===a){var m=this.clone().set(c,1);m.$d[d](h),m.init(),this.$d=m.set(c,Math.min(this.$D,m.daysInMonth())).$d}else d&&this.$d[d](h);return this.init(),this},h.set=function(e,t){return this.clone().$set(e,t)},h.get=function(e){return this[y.p(e)]()},h.add=function(e,o){var c,u=this;e=Number(e);var l=y.p(o),f=function(t){var n=v(u);return y.w(n.date(n.date()+Math.round(t*e)),u)};if(l===i)return this.set(i,this.$M+e);if(l===a)return this.set(a,this.$y+e);if("day"===l)return f(1);if(l===s)return f(7);var d=((c={})[n]=6e4,c[r]=36e5,c[t]=1e3,c)[l]||1,h=this.$d.getTime()+e*d;return y.w(h,this)},h.subtract=function(e,t){return this.add(-1*e,t)},h.format=function(e){var t=this,n=this.$locale();if(!this.isValid())return n.invalidDate||u;var r=e||"YYYY-MM-DDTHH:mm:ssZ",s=y.z(this),i=this.$H,o=this.$m,a=this.$M,c=n.weekdays,l=n.months,d=n.meridiem,h=function(e,n,s,i){return e&&(e[n]||e(t,r))||s[n].slice(0,i)},m=function(e){return y.s(i%12||12,e,"0")},p=d||function(e,t,n){var r=e<12?"AM":"PM";return n?r.toLowerCase():r};return r.replace(f,function(e,r){return r||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return y.s(t.$y,4,"0");case"M":return a+1;case"MM":return y.s(a+1,2,"0");case"MMM":return h(n.monthsShort,a,l,3);case"MMMM":return h(l,a);case"D":return t.$D;case"DD":return y.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return h(n.weekdaysMin,t.$W,c,2);case"ddd":return h(n.weekdaysShort,t.$W,c,3);case"dddd":return c[t.$W];case"H":return String(i);case"HH":return y.s(i,2,"0");case"h":return m(1);case"hh":return m(2);case"a":return p(i,o,!0);case"A":return p(i,o,!1);case"m":return String(o);case"mm":return y.s(o,2,"0");case"s":return String(t.$s);case"ss":return y.s(t.$s,2,"0");case"SSS":return y.s(t.$ms,3,"0");case"Z":return s}return null}(e)||s.replace(":","")})},h.utcOffset=function(){return-(15*Math.round(this.$d.getTimezoneOffset()/15))},h.diff=function(e,c,u){var l,f=this,d=y.p(c),h=v(e),m=(h.utcOffset()-this.utcOffset())*6e4,p=this-h,$=function(){return y.m(f,h)};switch(d){case a:l=$()/12;break;case i:l=$();break;case o:l=$()/3;break;case s:l=(p-m)/6048e5;break;case"day":l=(p-m)/864e5;break;case r:l=p/36e5;break;case n:l=p/6e4;break;case t:l=p/1e3;break;default:l=p}return u?l:y.a(l)},h.daysInMonth=function(){return this.endOf(i).$D},h.$locale=function(){return m[this.$L]},h.locale=function(e,t){if(!e)return this.$L;var n=this.clone(),r=g(e,t,!0);return r&&(n.$L=r),n},h.clone=function(){return y.w(this.$d,this)},h.toDate=function(){return new Date(this.valueOf())},h.toJSON=function(){return this.isValid()?this.toISOString():null},h.toISOString=function(){return this.$d.toISOString()},h.toString=function(){return this.$d.toUTCString()},d}(),O=S.prototype;return v.prototype=O,[["$ms",e],["$s",t],["$m",n],["$H",r],["$W","day"],["$M",i],["$y",a],["$D",c]].forEach(function(e){O[e[1]]=function(t){return this.$g(t,e[0],e[1])}}),v.extend=function(e,t){return e.$i||(e(t,S,v),e.$i=!0),v},v.locale=g,v.isDayjs=$,v.unix=function(e){return v(1e3*e)},v.en=m[h],v.Ls=m,v.p={},v}()}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[447,580],()=>n(2750));module.exports=r})();